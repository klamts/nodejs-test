<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Grammar Game: Nouns</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background: #f4f9fb;
      padding: 20px;
    }
    .question-card {
      background: #e0f7fa;
      padding: 20px;
      border-radius: 15px;
      width: 600px;
      margin: auto;
      box-shadow: 2px 2px 10px #ccc;
    }
    .options button, .extra-controls button {
      padding: 10px 20px;
      margin: 10px;
      font-size: 16px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
    }
    .feedback {
      font-weight: bold;
      margin-top: 10px;
    }
      .blinking {
    animation: blink 1s steps(2, start) infinite;
  }
  @keyframes blink {
    to {
      visibility: hidden;
    }
  }
  </style>
</head>
<body>
 <div style="margin-top: 20px;">
    <label for="voiceSelect">ğŸ”Š Chá»n giá»ng Ä‘á»c:</label>
    <select id="voiceSelect"></select>
  </div>
  <h2>Singular and Plural Noun Practice</h2>

  <div class="rules">
    <h3>ğŸ“˜ Grammar Rules</h3>
    <ul>
      <li><strong>1 A noun name a person</strong><br> <em> My <u>sister</u> and I play together. </em></li>
      <li><strong>2 A noun names a place</strong><br> <em> Eunji play in  the <u>park</u>. </em></li>
      <li><strong>3 A noun names a thing</strong><br> <em> My family lives in a <u>house</u>. </em></li>
    </ul>
  </div>


<h2>ğŸ“˜ Grammar Game â€“ Person / Place / Thing</h2>

<div class="question-card">
  <p id="sentence"></p>
  <div class="options">
    <button onclick="checkAnswer('person')">ğŸ‘¤ Person</button>
    <button onclick="checkAnswer('place')">ğŸï¸ Place</button>
    <button onclick="checkAnswer('thing')">ğŸ“¦ Thing</button>
  </div>

  <div class="extra-controls">
    <button onclick="speakSentence()">ğŸ”Š Äá»c cÃ¢u</button>
    <button onclick="startListening()">ğŸ™ï¸ NÃ³i cÃ¢u</button>
    <button onclick="playUserRecording()">ğŸ” Nghe láº¡i giá»ng mÃ¬nh</button>
  </div>

  <p class="feedback" id="feedback"></p>
  <button onclick="nextQuestion()">ğŸ” Next</button>
</div>
<p id="recordingStatus"></p>
<p id="transcript">ğŸ—£ï¸ Báº¡n nÃ³i: ...</p>
<audio id="userAudio" controls style="display:none;"></audio>

<script>
 const questions = [
  { text: "First we eat a big breakfast.", type: "thing", highlight: "breakfast" },
  { text: "Then we go to the park.", type: "place", highlight: "park" },
  { text: "My father runs with me.", type: "person", highlight: "father" },
  { text: "My friend meets us there.", type: "person", highlight: "friend" },
  { text: "We play with a ball.", type: "thing", highlight: "ball" },
  { text: "Finally we go home.", type: "place", highlight: "home" }
];

  let currentIndex = 0;
  let mediaRecorder;
  let audioChunks = [];
  let recordedAudio = null;
  let userAudioBlob = null;
  let lastSpoken = "";
  function loadQuestion() {
  const question = questions[currentIndex];
  const sentence = question.text;
  const keyword = question.highlight;

  // Gáº¡ch dÆ°á»›i keyword (danh tá»«)
  const highlighted = sentence.replace(
    new RegExp(`\\b(${keyword})\\b`, 'i'),
    '<u>$1</u>'
  );

  document.getElementById("sentence").innerHTML = highlighted;
  document.getElementById("feedback").innerText = "";
}

  function checkAnswer(userChoice) {
    const correct = questions[currentIndex].type;
    if (userChoice === correct) {
      document.getElementById("feedback").innerText = "âœ… ÄÃºng rá»“i!";
    } else {
      document.getElementById("feedback").innerText = `âŒ Sai rá»“i. ÄÃ¡p Ã¡n lÃ : ${correct}`;
    }
  }

  function nextQuestion() {
    currentIndex = (currentIndex + 1) % questions.length;
    loadQuestion();
  }

  function speakSentence() {
  const utterance = new SpeechSynthesisUtterance(questions[currentIndex].text);
  utterance.rate = 1.0;
  utterance.pitch = 1.0;

  if (selectedVoice) {
    utterance.voice = selectedVoice;
  } else {
    console.warn("âš ï¸ ChÆ°a cÃ³ giá»ng Ä‘á»c nÃ o Ä‘Æ°á»£c chá»n. DÃ¹ng máº·c Ä‘á»‹nh.");
  }

  speechSynthesis.speak(utterance);
}

  async function startRecording() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      audioChunks = [];
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        recordedAudio = new Audio(URL.createObjectURL(audioBlob));
      };
      mediaRecorder.start();
      setTimeout(() => {
        mediaRecorder.stop();
      }, 4000); // 4 giÃ¢y thu Ã¢m
    } catch (err) {
      alert("ğŸ¤ KhÃ´ng thá»ƒ thu Ã¢m. HÃ£y kiá»ƒm tra micro.");
    }
  }

  function playRecording() {
    if (recordedAudio) {
      recordedAudio.play();
    } else {
      alert("ğŸ§ ChÆ°a cÃ³ báº£n ghi nÃ o.");
    }
  }

  // Load voices Ä‘á»ƒ trÃ¡nh delay khi phÃ¡t
  window.speechSynthesis.onvoiceschanged = () => {};
  function startListening() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert("âŒ TrÃ¬nh duyá»‡t cá»§a báº¡n khÃ´ng há»— trá»£ Speech Recognition.");
    return;
  }

  const recognition = new SpeechRecognition();
  recognition.lang = "en-US";
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  recognition.start();

  recognition.onresult = (event) => {
    const spoken = event.results[0][0].transcript.trim();
    lastSpoken = spoken;
    document.getElementById("transcript").textContent = `ğŸ—£ï¸ Báº¡n nÃ³i: "${spoken}"`;

    const expected = questions[currentIndex].text.toLowerCase().replace(/[.]/g, "");
    const said = spoken.toLowerCase().replace(/[.]/g, "");

    if (said === expected) {
      document.getElementById("feedback").textContent = "âœ… ÄÃºng rá»“i!";
    } else {
      document.getElementById("feedback").textContent = `âŒ Sai. CÃ¢u Ä‘Ãºng: "${questions[currentIndex].text}"`;
    }
  };

  recognition.onerror = () => {
    document.getElementById("feedback").textContent = "âŒ Lá»—i nháº­n diá»‡n giá»ng nÃ³i.";
  };

  // ======== GHI Ã‚M GIá»ŒNG NGÆ¯á»œI DÃ™NG ========
  navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
    const mediaRecorder = new MediaRecorder(stream);
    const chunks = [];

    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = () => {
      userAudioBlob = new Blob(chunks, { type: 'audio/webm' });
      const audioURL = URL.createObjectURL(userAudioBlob);
      const audio = document.getElementById("userAudio");
      audio.src = audioURL;
      audio.style.display = "block";
    };

    mediaRecorder.start();
    setTimeout(() => {
      mediaRecorder.stop();
    }, 4000);
  });

  // Hiá»ƒn thá»‹ tráº¡ng thÃ¡i ghi Ã¢m
  const statusElem = document.getElementById("recordingStatus");
  statusElem.textContent = "ğŸ”´ Äang ghi Ã¢m...";
  statusElem.classList.add("blinking");

  // áº¨n sau 4 giÃ¢y
  setTimeout(() => {
    statusElem.textContent = "";
    statusElem.classList.remove("blinking");
  }, 4000);
}

function playUserRecording() {
  const audio = document.getElementById("userAudio");
  if (userAudioBlob) {
    audio.play();
  } else {
    alert("ChÆ°a cÃ³ báº£n ghi Ã¢m nÃ o!");
  }
}
function loadVoices() {
    const voiceSelect = document.getElementById('voiceSelect');
    const voices = window.speechSynthesis.getVoices();

    // XÃ³a lá»±a chá»n cÅ© (náº¿u cÃ³)
    voiceSelect.innerHTML = '';

    voices.forEach((voice, index) => {
      const option = document.createElement('option');
      option.value = index;
      option.textContent = `${index + 1}. ${voice.name} (${voice.lang})`;
      voiceSelect.appendChild(option);
    });

    // Máº·c Ä‘á»‹nh chá»n giá»ng Ä‘áº§u tiÃªn
    selectedVoice = voices[114];
    voiceSelect.selectedIndex = 114;

    voiceSelect.addEventListener('change', () => {
      selectedVoice = voices[voiceSelect.value];
    });
  }

  // Gá»i sau khi danh sÃ¡ch voice Ä‘Æ°á»£c cáº­p nháº­t
  window.speechSynthesis.onvoiceschanged = loadVoices;
  function speak(text) {
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.rate = 1.14;
  utterance.lang = 'en-US';

  if (selectedVoice) {
    utterance.voice = selectedVoice;
    console.log("Using voice:", selectedVoice.name);
  } else {
    console.warn("âš ï¸ No voice selected.");
  }

  window.speechSynthesis.speak(utterance);
}

  loadQuestion();
</script>

</body>
</html>
