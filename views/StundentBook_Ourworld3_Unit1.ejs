<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ğŸ—£ï¸ Há»™i thoáº¡i tÆ°Æ¡ng tÃ¡c A1</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    #image { width: 200px; margin: 10px auto; }
    #question { font-size: 20px; margin-top: 20px; }
    #transcript { font-style: italic; margin-top: 10px; color: gray; }
    #feedback { font-weight: bold; font-size: 18px; margin-top: 15px; }
    button { padding: 10px 20px; margin: 10px; font-size: 16px; }
    .correct { color: green; }
    .incorrect { color: red; }
    .blinking {animation: blinker 1s linear infinite;}
    @keyframes blinker {50% { opacity: 0; }}
  </style>
</head>
<body>
<a href="/hoithoai/hoithoaiourworld3_unit0" >Há»˜I THOáº I</a><br>
<a href="/ourworld3/unit0" >SEASONS AND MONTHS</a><br>

<a href="/practice/3/unit0" >LUYá»†N Tá»ª </a><br>
<a href="/baihoc/StundentBook_Ourworld3_Unit0/hoi_va_traloi" >Há»I VÃ€ TRáº¢ Lá»œI</a><br>
<a href="/baihoc/StundentBook_Ourworld3_Unit0/hoi_va_traloi1" >Há»I VÃ€ TRáº¢ Lá»œI 1</a><br>

<a href="/docvaviet/docvaviet_ourworld3_unit0" >Äá»ŒC VÃ€ VIáº¾T</a><br>
<div id="audioList" style="list-style: none; padding: 0;">
  <h3>ğŸ“‚ Danh sÃ¡ch Track</h3>
  <ul id="trackList" style="
  list-style: none;
  padding: 0;
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
"></ul>
</div>
<audio id="introAudio" controls style="margin-top: 10px;"></audio>
<p><strong id="audioTitle">ğŸµ Äang phÃ¡t: </strong></p>

 
  <script>
    const audio = document.getElementById("introAudio");
  const title = document.getElementById("audioTitle");
  const list = document.getElementById("trackList");

  fetch('/list-audio?unit=1')
    .then(res => res.json())
    .then(files => {
      files.forEach(file => {
        const li = document.createElement("li");
        const btn = document.createElement("button");
        btn.textContent = file.label;
        btn.onclick = () => {
          audio.src = "/audio/" + file.name;
          audio.play();
          title.textContent = "ğŸµ Äang phÃ¡t: " + file.label;
        };
        li.appendChild(btn);
        list.appendChild(li);
      });
    })
    .catch(err => {
      list.innerHTML = "<li>KhÃ´ng táº£i Ä‘Æ°á»£c danh sÃ¡ch audio.</li>";
      console.error(err);
    });
    let dialogues = [];
    let current = 0;
    let voices = [];
    let lastSpoken = ''; // lÆ°u lá»i há»c sinh nÃ³i Ä‘á»ƒ phÃ¡t láº¡i
    let userAudioBlob = null; // lÆ°u Ã¢m thanh ngÆ°á»i dÃ¹ng
    // Load voices khi cÃ³ sáºµn
    function loadVoices() {
      voices = speechSynthesis.getVoices();
      const voiceSelect = document.getElementById('voiceSelect');
      voiceSelect.innerHTML = '';
      voices.forEach((voice, i) => {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = `${voice.name} (${voice.lang})`;
        voiceSelect.appendChild(option);
      });
      voiceSelect.selectedIndex = 114;
    }

    // CÃ³ browsers cáº§n Ä‘á»£i
    speechSynthesis.onvoiceschanged = loadVoices;

    fetch('/data/dialoguesourworld3_unit0_1.json')
      .then(res => res.json())
      .then(data => {
        dialogues = data;
        showDialogue();
      })
      .catch(err => {
        document.getElementById("question").textContent = "âŒ KhÃ´ng táº£i Ä‘Æ°á»£c dá»¯ liá»‡u.";
        console.error(err);
      });

    function showDialogue() {
      const d = dialogues[current];
      document.getElementById("question").textContent = d.question;
      document.getElementById("wordImage").src = "/" + d.image_url.replace(/^\/?/, '');
      document.getElementById("transcript").textContent = "";
      document.getElementById("feedback").textContent = "";
    }

    function nextDialogue() {
      current = (current + 1) % dialogues.length;
      showDialogue();
    }

    function speakQuestion() {
      const d = dialogues[current];
      const utterance = new SpeechSynthesisUtterance(d.question);
      utterance.lang = "en-US";

      const selectedIndex = parseInt(document.getElementById("voiceSelect").value);
      if (voices[selectedIndex]) {
        utterance.voice = voices[selectedIndex];
      }

      speechSynthesis.speak(utterance);
    }

    function playBack() {
        
      const expected = dialogues[current].expected_answer.toLowerCase();
      
      const utterance = new SpeechSynthesisUtterance(expected);
      utterance.lang = "en-US";

      const selectedIndex = parseInt(document.getElementById("voiceSelect").value);
      if (voices[selectedIndex]) {
        utterance.voice = voices[selectedIndex];
      }

      speechSynthesis.speak(utterance);
    }

    function startListening() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        alert("TrÃ¬nh duyá»‡t cá»§a báº¡n khÃ´ng há»— trá»£ Speech Recognition.");
        return;
      }

      const recognition = new SpeechRecognition();
      recognition.lang = "en-US";
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.start();

      recognition.onresult = (event) => {
        const spoken = event.results[0][0].transcript.trim();
        lastSpoken = spoken; // lÆ°u láº¡i Ä‘á»ƒ phÃ¡t láº¡i
        document.getElementById("transcript").textContent = `ğŸ—£ï¸ Báº¡n nÃ³i: "${spoken}"`;

        const expected = dialogues[current].expected_answer.toLowerCase();
        const said = spoken.toLowerCase();

        if (said === expected) {
          document.getElementById("feedback").textContent = "âœ… ÄÃºng rá»“i!";
          document.getElementById("feedback").className = "correct";
          document.getElementById("soundCorrect").play(); // âœ… phÃ¡t Ã¢m Ä‘Ãºng
        } else {
          document.getElementById("feedback").textContent = `âŒ Sai. ÄÃ¡p Ã¡n Ä‘Ãºng: "${dialogues[current].expected_answer}"`;
          document.getElementById("feedback").className = "incorrect";
          document.getElementById("soundWrong").play();   // âŒ phÃ¡t Ã¢m sai
        }
      };

      recognition.onerror = () => {
        document.getElementById("feedback").textContent = "âŒ Lá»—i nháº­n diá»‡n giá»ng nÃ³i.";
        document.getElementById("feedback").className = "incorrect";
      };
            // === GHI Ã‚M GIá»ŒNG NGÆ¯á»œI DÃ™NG ===
        navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
            const mediaRecorder = new MediaRecorder(stream);
            const chunks = [];

            mediaRecorder.ondataavailable = e => chunks.push(e.data);
            mediaRecorder.onstop = () => {
            userAudioBlob = new Blob(chunks, { type: 'audio/webm' });
            const audioURL = URL.createObjectURL(userAudioBlob);
            const audio = document.getElementById("userAudio");
            audio.src = audioURL;
            audio.style.display = "block";
            };

            mediaRecorder.start();

            // Dá»«ng ghi sau 4 giÃ¢y (hoáº·c tuá»³)
            setTimeout(() => {
            mediaRecorder.stop();
            }, 4000);
        });
                // Hiá»ƒn thá»‹ tráº¡ng thÃ¡i ghi Ã¢m
        const statusElem = document.getElementById("recordingStatus");
        statusElem.textContent = "ğŸ”´ Äang ghi Ã¢m...";
        statusElem.classList.add("blinking");

        // Sau khi ghi Ã¢m xong thÃ¬ áº©n Ä‘i (sau 4 giÃ¢y)
        setTimeout(() => {
        statusElem.textContent = "";
        statusElem.classList.remove("blinking");
        }, 4000);

    }
    function playUserRecording() {
  const audio = document.getElementById("userAudio");
  if (userAudioBlob) {
    audio.play();
  } else {
    alert("ChÆ°a cÃ³ báº£n ghi Ã¢m nÃ o!");
  }
}
  </script>
</body>
</html>
