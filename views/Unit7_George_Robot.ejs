<h2>ğŸ¤ Question Practice â€“ Georgeâ€™s Robot</h2>

<div id="question-box" style="max-width: 800px; margin: auto;">
  <div id="progress" style="margin-bottom: 10px; color: blue;"></div>
  
  <p id="question-text" style="font-size: 1.2em; font-weight: bold;"></p>

  <button onclick="speak()">ğŸ”Š Nghe láº¡i cÃ¢u há»i</button>
  <button onclick="startRecording()">ğŸ™ï¸ Ghi Ã¢m cÃ¢u tráº£ lá»i</button>
  <button onclick="stopRecording()">â¹ Dá»«ng & Gá»­i</button>

  <p id="loading" style="color: orange; font-weight: bold;"></p>

  <p id="result" style="margin-top: 15px;"></p>

  <div id="answer-stick" style="margin-top: 10px; font-style: italic; color: #888;"></div>

  <div style="margin-top: 20px;">
    <button onclick="nextQuestion()" id="nextBtn" style="display:none; background: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 6px;">â–¶ï¸ CÃ¢u tiáº¿p</button>
  </div>
</div>

<script>
  const questions = <%- JSON.stringify(words) %>;
  let currentIndex = 0;
  let mediaRecorder, audioChunks = [];

  function speak() {
    const utter = new SpeechSynthesisUtterance(questions[currentIndex].question);
    utter.lang = 'en-US';
    speechSynthesis.speak(utter);
  }

  function showQuestion() {
    document.getElementById('question-text').innerText = questions[currentIndex].question;
    document.getElementById('result').innerText = '';
    document.getElementById('answer-stick').innerText = '';
    document.getElementById('nextBtn').style.display = 'none';
    document.getElementById('progress').innerText = `CÃ¢u ${currentIndex + 1} / ${questions.length}`;
  }

  async function startRecording() {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = uploadAudio;
    mediaRecorder.start();
    document.getElementById('loading').innerText = "â³ Äang ghi Ã¢m...";
  }

  function stopRecording() {
    document.getElementById('loading').innerText = "â³ Äang gá»­i vÃ  cháº¥m Ä‘iá»ƒm...";
    mediaRecorder.stop();
  }

  function uploadAudio() {
    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
    const formData = new FormData();
    formData.append('audio', audioBlob);
    formData.append('expected', questions[currentIndex].answer);

    fetch('/questionanswer/upload', {
      method: 'POST',
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      document.getElementById('loading').innerText = '';
      document.getElementById('result').innerText = `ğŸ—£ï¸ Báº¡n nÃ³i: ${data.userSaid} â€” ${data.isCorrect ? 'âœ… ÄÃºng' : 'âŒ Sai'}`;
      document.getElementById('answer-stick').innerText = `ğŸ“Œ ÄÃ¡p Ã¡n Ä‘Ãºng: ${questions[currentIndex].answer}`;
      document.getElementById('nextBtn').style.display = 'inline-block';
    });
  }

  function nextQuestion() {
    if (currentIndex < questions.length - 1) {
      currentIndex++;
      showQuestion();
    } else {
      document.getElementById('question-box').innerHTML = "<h3>ğŸ‰ Báº¡n Ä‘Ã£ hoÃ n thÃ nh táº¥t cáº£ cÃ¡c cÃ¢u há»i!</h3>";
    }
  }

  // Khá»Ÿi Ä‘á»™ng cÃ¢u Ä‘áº§u tiÃªn
  showQuestion();
</script>
