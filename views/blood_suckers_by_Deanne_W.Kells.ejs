
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ—£ï¸ Luyá»‡n phÃ¡t Ã¢m tá»« vá»±ng</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      padding: 20px;
      background: #f0f2f5;
      color: #333;
    }
    h1, h2 {
      text-align: center;
      color: #0056b3;
    }
    .word-card {
      background: white;
      padding: 20px;
      margin: 20px auto;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-width: 600px;
    }
    .word-card h2 {
      color: #007bff;
      font-size: 2em;
    }
    .word-details {
      text-align: center;
      color: #555;
    }
    .ipa-compare {
      font-family: 'Courier New', monospace;
      margin-top: 10px;
      font-size: 1.1em;
    }
    .match {
      color: green;
    }
    .mismatch {
      color: red;
      text-decoration: underline;
    }
    .buttons-container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }
    button {
      padding: 8px 15px;
      border-radius: 20px;
      border: none;
      background-color: #28a745;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #218838;
    }
    .result {
      text-align: center;
      margin-top: 10px;
      font-weight: bold;
    }
    .correct { color: #28a745; }
    .incorrect { color: #dc3545; }
    .progress-bar {
      width: 100%;
      height: 10px;
      display: none;
      margin-top: 10px;
    }
    table {
      width: 100%;
      margin-top: 30px;
      border-collapse: collapse;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ccc;
      text-align: left;
    }
    th {
      background-color: #e0e0e0;
    }
    .result.correct {
      color: green;
    }

    .result.incorrect {
      color: red;
    }

    .expected-word {
      font-weight: bold;
      color: #007bff;
    }

    .user-word {
      font-weight: bold;
      color: #ff5722;
    }
    .image-container img {
      max-width: 200px;
      margin: 10px auto;
      display: block;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  


  

  <h1>ğŸ—£ï¸ Luyá»‡n phÃ¡t Ã¢m tá»« vá»±ng</h1>
  <input type="text" class="learner-name" placeholder="TÃªn cá»§a báº¡n">
  <label for="voiceSelect">ğŸ”Š Chá»n giá»ng Ä‘á»c: </label>
  <select id="voiceSelect"></select>
  <% words.forEach(word => { %>
    <div class="word-card" data-word="<%= word.word_text.toLowerCase() %>">
      <h2><%= word.word_text %></h2>
      <div class="word-details">
        <span><%= word.meaning_vi %></span><br>
        <span><i><%= word.ipa %></i> | <%= word.pos %></span>
      </div>
      <% if (word.image_url) { %>
        <div class="image-container">
          <img src="/<%= word.image_url %>" alt="<%= word.word_text %>">
        </div>
      <% } %>
      <p><b>VD:</b> <i><%= word.example_en %></i><br><%= word.example_vi %></p>
      <div class="buttons-container">
        <input type="hidden" class="expected-word" value="<%= word.word_text %>">
        <button onclick="speak('<%= word.word_text %>')">ğŸ”Š Nghe phÃ¡t Ã¢m</button>
        <button onclick="recordAndSend(this)">ğŸ™ï¸ NÃ³i thá»­</button>
        <button class="replay-button" onclick="replayRecording(this)" disabled>ğŸ” Nghe láº¡i</button>
      </div>
      <progress class="progress-bar" value="0" max="100"></progress>
      <div class="result"></div>
      <div class="ipa-compare"></div>
    </div>
  <% }); %>

  <h2>Lá»‹ch sá»­ luyá»‡n táº­p</h2>
  <table id="historyTable">
    <thead>
      <tr><th>Tá»«</th><th>Báº¡n nÃ³i</th><th>Äiá»ƒm</th><th>Káº¿t quáº£</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <audio id="soundCorrect" src="/sounds/correct.mp3"></audio>
  <audio id="soundWrong" src="/sounds/wrong.mp3"></audio>
  <script>
    let voices = [];

    function loadVoices() {
  voices = speechSynthesis.getVoices();
  const voiceSelect = document.getElementById("voiceSelect");
  voiceSelect.innerHTML = '';

  let defaultIndex = 0;

    voices.forEach((voice, i) => {
        const option = document.createElement("option");
        option.value = i;
        option.textContent = `${voice.name} (${voice.lang})`;
        voiceSelect.appendChild(option);

        // GÃ¡n chá»‰ sá»‘ náº¿u trÃ¹ng vá»›i Microsoft Ana
        if (
          voice.name === "Microsoft Ana Online (Natural)" &&
          voice.lang === "en-US"
        ) {
          defaultIndex = i;
        }
      });

      voiceSelect.selectedIndex = 114;
    }

    // Äáº£m báº£o cháº¡y khi danh sÃ¡ch voice cÃ³ sáºµn
    if (speechSynthesis.getVoices().length === 0) {
      speechSynthesis.onvoiceschanged = loadVoices;
    } else {
      loadVoices();
    }

    // CÃ³ browsers cáº§n Ä‘á»£i
    speechSynthesis.onvoiceschanged = loadVoices;
    // VÃ­ dá»¥: URL hiá»‡n táº¡i lÃ  "/practice/unit8"
    const currentPath = window.location.pathname; 
    const unitMatch = currentPath.match(/\/practice\/(unit\d+)/);
    const unit = unitMatch ? unitMatch[1] : 'unit8'; // fallback náº¿u khÃ´ng tÃ¬m Ä‘Æ°á»£c

    
    function speak(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "en-US";
      const selectedIndex = parseInt(document.getElementById("voiceSelect")?.value);
      if (voices[selectedIndex]) {
        utterance.voice = voices[selectedIndex];
      }
      speechSynthesis.speak(utterance);
    }


    function replayRecording(button) {
      const card = button.closest('.word-card');
      const blobUrl = card.dataset.blobUrl;
      if (blobUrl) new Audio(blobUrl).play();
    }

// âœ… Ghi Ã¢m vÃ  nháº­n dáº¡ng, khÃ´ng gá»­i lÃªn server
// âœ… Ghi Ã¢m vÃ  nháº­n dáº¡ng, khÃ´ng gá»­i lÃªn server
async function recordAndSend(button) {
  const card = button.closest('.word-card');
  const expectedElem = card.querySelector('.expected-word');
  const expectedWord = expectedElem?.dataset.word?.toLowerCase() || expectedElem?.value?.toLowerCase() || '';
  const learnerName = document.querySelector('.learner-name')?.value || 'áº¨n danh';
  const resultElem = card.querySelector('.result');
  const progressBar = card.querySelector('.progress-bar');
  const replayButton = card.querySelector('.replay-button');
  const ipaCompareElem = card.querySelector('.ipa-compare');

  if (!expectedWord) {
    alert('â— KhÃ´ng tÃ¬m tháº¥y tá»« cáº§n luyá»‡n táº­p (expectedWord). Kiá»ƒm tra láº¡i HTML.');
    return;
  }

  if (!learnerName || learnerName.trim() === '') {
    alert('Vui lÃ²ng nháº­p tÃªn trÆ°á»›c khi luyá»‡n táº­p.');
    return;
  }

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert("TrÃ¬nh duyá»‡t cá»§a báº¡n khÃ´ng há»— trá»£ Speech Recognition.");
    return;
  }

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const mediaRecorder = new MediaRecorder(stream);
    const chunks = [];

    const recognition = new SpeechRecognition();
    recognition.lang = "en-US";
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    resultElem.textContent = 'ğŸ¤ Äang ghi Ã¢m vÃ  nháº­n dáº¡ng...';
    resultElem.className = 'result';
    progressBar.style.display = 'block';
    progressBar.value = 10;

    const statusElem = card.querySelector(".recording-status");
    if (statusElem) {
      statusElem.textContent = "ğŸ”´ Äang ghi Ã¢m...";
      statusElem.classList.add("blinking");
    }

    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = () => {
      const blob = new Blob(chunks, { type: 'audio/webm' });
      const url = URL.createObjectURL(blob);
      card.dataset.blobUrl = url;
      replayButton.disabled = false;

      progressBar.value = 100;
      setTimeout(() => progressBar.style.display = 'none', 1000);

      if (statusElem) {
        statusElem.textContent = "";
        statusElem.classList.remove("blinking");
      }
    };

    recognition.onresult = (event) => {
      const spoken = event.results[0][0].transcript.trim();
      const said = spoken.toLowerCase().replace(/[.?!]$/g, '').trim();
      const isCorrect = said === expectedWord;

      if (isCorrect) {
        resultElem.innerHTML = `âœ… ÄÃºng rá»“i!<br>ğŸ—£ï¸ Báº¡n nÃ³i: <strong>${spoken}</strong>`;
        resultElem.className = 'result correct';
        document.getElementById("soundCorrect").play(); // âœ… phÃ¡t Ã¢m Ä‘Ãºng
      } else {
        resultElem.innerHTML = `âŒ Sai rá»“i. Báº¡n nÃ³i: <strong>${spoken}</strong><br>âœ… Tá»« Ä‘Ãºng lÃ : <strong>${expectedWord}</strong>`;
        resultElem.className = 'result incorrect';
        document.getElementById("soundWrong").play();   // âŒ phÃ¡t Ã¢m sai
      }
    };

    recognition.onerror = () => {
      resultElem.textContent = "âŒ Lá»—i nháº­n diá»‡n giá»ng nÃ³i.";
      resultElem.className = 'result incorrect';
    };

    mediaRecorder.start();
    recognition.start();

    setTimeout(() => {
      mediaRecorder.stop();
      recognition.stop();
    }, 4000);

  } catch (err) {
    alert('Lá»—i ghi Ã¢m hoáº·c nháº­n diá»‡n: ' + err.message);
  }
}

async function recordAndSend(button) {
  const card = button.closest('.word-card');
  const expectedElem = card.querySelector('.expected-word');
  const expectedWord = expectedElem?.dataset.word?.toLowerCase() || expectedElem?.value?.toLowerCase() || '';
  const learnerName = document.querySelector('.learner-name')?.value || 'áº¨n danh';
  const resultElem = card.querySelector('.result');
  const progressBar = card.querySelector('.progress-bar');
  const replayButton = card.querySelector('.replay-button');
  const ipaCompareElem = card.querySelector('.ipa-compare');

  if (!expectedWord) {
    alert('â— KhÃ´ng tÃ¬m tháº¥y tá»« cáº§n luyá»‡n táº­p (expectedWord). Kiá»ƒm tra láº¡i HTML.');
    return;
  }

  if (!learnerName || learnerName.trim() === '') {
    alert('Vui lÃ²ng nháº­p tÃªn trÆ°á»›c khi luyá»‡n táº­p.');
    return;
  }

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert("TrÃ¬nh duyá»‡t cá»§a báº¡n khÃ´ng há»— trá»£ Speech Recognition.");
    return;
  }

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const mediaRecorder = new MediaRecorder(stream);
    const chunks = [];

    const recognition = new SpeechRecognition();
    recognition.lang = "en-US";
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    resultElem.textContent = 'ğŸ¤ Äang ghi Ã¢m vÃ  nháº­n dáº¡ng...';
    resultElem.className = 'result';
    progressBar.style.display = 'block';
    progressBar.value = 10;

    const statusElem = card.querySelector(".recording-status");
    if (statusElem) {
      statusElem.textContent = "ğŸ”´ Äang ghi Ã¢m...";
      statusElem.classList.add("blinking");
    }

    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = () => {
      const blob = new Blob(chunks, { type: 'audio/webm' });
      const url = URL.createObjectURL(blob);
      card.dataset.blobUrl = url;
      replayButton.disabled = false;

      progressBar.value = 100;
      setTimeout(() => progressBar.style.display = 'none', 1000);

      if (statusElem) {
        statusElem.textContent = "";
        statusElem.classList.remove("blinking");
      }
    };

    recognition.onresult = (event) => {
      const spoken = event.results[0][0].transcript.trim();
      const said = spoken.toLowerCase().replace(/[.?!]$/g, '').trim();
      const isCorrect = said === expectedWord;

      if (isCorrect) {
        resultElem.innerHTML = `âœ… ÄÃºng rá»“i!<br>ğŸ—£ï¸ Báº¡n nÃ³i: <strong>${spoken}</strong>`;
        resultElem.className = 'result correct';
        document.getElementById("soundCorrect").play(); // âœ… phÃ¡t Ã¢m Ä‘Ãºng
      } else {
        resultElem.innerHTML = `âŒ Sai rá»“i. Báº¡n nÃ³i: <strong>${spoken}</strong><br>âœ… Tá»« Ä‘Ãºng lÃ : <strong>${expectedWord}</strong>`;
        resultElem.className = 'result incorrect';
        document.getElementById("soundWrong").play();   // âŒ phÃ¡t Ã¢m sai
      }
    };

    recognition.onerror = () => {
      resultElem.textContent = "âŒ Lá»—i nháº­n diá»‡n giá»ng nÃ³i.";
      resultElem.className = 'result incorrect';
    };

    mediaRecorder.start();
    recognition.start();

    setTimeout(() => {
      mediaRecorder.stop();
      recognition.stop();
    }, 4000);

  } catch (err) {
    alert('Lá»—i ghi Ã¢m hoáº·c nháº­n diá»‡n: ' + err.message);
  }
}

  </script>
</body>
</html>