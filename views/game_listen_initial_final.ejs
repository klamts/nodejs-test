<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ”Š Luyá»‡n nghe Ã¢m IPA Ä‘áº§u/cuá»‘i</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    .choices button { margin: 10px; padding: 10px 20px; font-size: 16px; }
    .correct { color: green; font-weight: bold; }
    .incorrect { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h2>ğŸ”Š Nghe vÃ  chá»n <span id="mode-label">Ã¢m Ä‘áº§u IPA</span> - Unit <%= unit %></h2>
  <button onclick="toggleMode()">ğŸ” Äá»•i: Ã‚m Ä‘áº§u / Ã‚m cuá»‘i</button><br><br>
  <button onclick="playWord()">ğŸ§ Nghe tá»«</button>

  <div class="choices" id="choices"></div>
  <div id="feedback" class="result"></div>
  <button onclick="nextQuestion()">â­ Tá»« tiáº¿p theo</button>

  <script>
    const words = <%- JSON.stringify(words) %>;
    let current = null;
    let mode = 'start'; // hoáº·c 'end'

    const ipaConsonants = [
      'tÊƒ','dÊ’','Êƒ','Ê’','Î¸','Ã°','Å‹','t','d','k','g','p','b','s','z','m','n','l','r','f','v','h','j','w','Ê”'
    ];
    const ipaVowels = [
      'iË','Éª','e','Ã¦','ÊŒ','É‘Ë','É’','É”Ë','ÊŠ','uË','É™','ÉœË','eÉª','aÉª','É”Éª','aÊŠ','É™ÊŠ','ÉªÉ™','eÉ™','ÊŠÉ™'
    ];
    const ipaUnits = [...ipaConsonants, ...ipaVowels].sort((a, b) => b.length - a.length);

    function splitIPA(ipaText) {
      if (!ipaText) return [];
      let ipa = ipaText.replace(/^\/|\/$/g, '');
      const result = [];
      while (ipa.length > 0) {
        let matched = false;
        for (const unit of ipaUnits) {
          if (ipa.startsWith(unit)) {
            result.push(unit);
            ipa = ipa.slice(unit.length);
            matched = true;
            break;
          }
        }
        if (!matched) {
          result.push(ipa[0]);
          ipa = ipa.slice(1);
        }
      }
      return result;
    }

    function toggleMode() {
      mode = (mode === 'start') ? 'end' : 'start';
      document.getElementById("mode-label").innerText = mode === 'start' ? 'Ã¢m Ä‘áº§u IPA' : 'Ã¢m cuá»‘i IPA';
      nextQuestion();
    }

    function playWord() {
      const utterance = new SpeechSynthesisUtterance(current.word_text);
      utterance.lang = 'en-US';
      speechSynthesis.speak(utterance);
    }

    function getIpaSound(ipaText) {
      const ipaArr = splitIPA(ipaText);
      if (ipaArr.length === 0) return '';
      return mode === 'start' ? ipaArr[0] : ipaArr[ipaArr.length - 1];
    }

    function nextQuestion() {
      const word = words[Math.floor(Math.random() * words.length)];
      current = word;

      const correct = getIpaSound(word.ipa);
      if (!correct) return nextQuestion(); // bá» tá»« náº¿u IPA rá»—ng

      const distractors = ipaUnits.filter(s => s !== correct).sort(() => 0.5 - Math.random()).slice(0, 3);
      const options = [correct, ...distractors].sort(() => 0.5 - Math.random());

      const html = options.map(s => `<button onclick="check('${s}')">${s}</button>`).join('');
      document.getElementById("choices").innerHTML = html;
      document.getElementById("feedback").innerHTML = "";
    }

    function check(selected) {
      const correct = getIpaSound(current.ipa);
      const fb = document.getElementById("feedback");
      if (selected === correct) {
        fb.innerHTML = `âœ… ChÃ­nh xÃ¡c! Tá»« lÃ  <strong>${current.word_text}</strong><br>IPA: <code>${current.ipa}</code>`;
        fb.className = 'correct';
      } else {
        fb.innerHTML = `âŒ Sai. Tá»« lÃ  <strong>${current.word_text}</strong><br>${mode === 'start' ? 'Ã‚m Ä‘áº§u' : 'Ã‚m cuá»‘i'} Ä‘Ãºng lÃ : <strong>${correct}</strong><br>IPA: <code>${current.ipa}</code>`;
        fb.className = 'incorrect';
      }
    }

    nextQuestion();
  </script>
</body>
</html>
