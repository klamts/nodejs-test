<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ğŸ—£ï¸ Há»™i thoáº¡i tÆ°Æ¡ng tÃ¡c A1</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    #image { width: 200px; margin: 10px auto; }
    #question { font-size: 20px; margin-top: 20px; }
    #transcript { font-style: italic; margin-top: 10px; color: gray; }
    #feedback { font-weight: bold; font-size: 18px; margin-top: 15px; }
    button { padding: 10px 20px; margin: 10px; font-size: 16px; }
    .correct { color: green; }
    .incorrect { color: red; }
    .blinking {animation: blinker 1s linear infinite;}
    @keyframes blinker {50% { opacity: 0; }}
  </style>
</head>
<body>

  <h2>ğŸ—¨ï¸ Há»™i thoáº¡i tÆ°Æ¡ng tÃ¡c báº±ng giá»ng nÃ³i</h2>

  <label for="voiceSelect">ğŸ”Š Chá»n giá»ng Ä‘á»c: </label>
  <select id="voiceSelect"></select><br>

  <div id="image"><img id="wordImage" src="" alt="" width="200"></div>
  <div id="question">Loading...</div>
  <button onclick="speakQuestion()">ğŸ“¢ Äá»c cÃ¢u há»i</button>
  <button onclick="startListening()">ğŸ¤ Tráº£ lá»i</button>
  <button onclick="playBack()">ğŸ” Nghe cÃ¢u tráº£ lá»i</button>
  <button onclick="playUserRecording()">ğŸ” Nghe láº¡i báº¡n Ä‘á»c</button>
  <audio id="userAudio" controls style="display:none;"></audio>
  <div id="transcript"></div>
  <div id="feedback"></div>
  <button onclick="nextDialogue()">â­ Tá»« tiáº¿p theo</button>
  <audio id="soundCorrect" src="/sounds/correct.mp3"></audio>
  <audio id="soundWrong" src="/sounds/wrong.mp3"></audio>
  <div id="recordingStatus" style="margin-top: 10px; font-weight: bold; color: red;"></div>
  <script>
    let dialogues = [];
    let current = 0;
    let voices = [];
    let lastSpoken = ''; // lÆ°u lá»i há»c sinh nÃ³i Ä‘á»ƒ phÃ¡t láº¡i
    let userAudioBlob = null; // lÆ°u Ã¢m thanh ngÆ°á»i dÃ¹ng
    // Load voices khi cÃ³ sáºµn
    function loadVoices() {
      voices = speechSynthesis.getVoices();
      const voiceSelect = document.getElementById('voiceSelect');
      voiceSelect.innerHTML = '';
      voices.forEach((voice, i) => {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = `${voice.name} (${voice.lang})`;
        voiceSelect.appendChild(option);
      });
      voiceSelect.selectedIndex = 114;
    }

    // CÃ³ browsers cáº§n Ä‘á»£i
    speechSynthesis.onvoiceschanged = loadVoices;

    fetch('/data/dialogues_unit8.json')
      .then(res => res.json())
      .then(data => {
        dialogues = data;
        showDialogue();
      })
      .catch(err => {
        document.getElementById("question").textContent = "âŒ KhÃ´ng táº£i Ä‘Æ°á»£c dá»¯ liá»‡u.";
        console.error(err);
      });

    function showDialogue() {
      const d = dialogues[current];
      document.getElementById("question").textContent = d.question;
      document.getElementById("wordImage").src = "/" + d.image_url.replace(/^\/?/, '');
      document.getElementById("transcript").textContent = "";
      document.getElementById("feedback").textContent = "";
    }

    function nextDialogue() {
      current = (current + 1) % dialogues.length;
      showDialogue();
    }

    function speakQuestion() {
      const d = dialogues[current];
      const utterance = new SpeechSynthesisUtterance(d.question);
      utterance.lang = "en-US";

      const selectedIndex = parseInt(document.getElementById("voiceSelect").value);
      if (voices[selectedIndex]) {
        utterance.voice = voices[selectedIndex];
      }

      speechSynthesis.speak(utterance);
    }

    function playBack() {
        
      const expected = dialogues[current].expected_answer.toLowerCase();
      
      const utterance = new SpeechSynthesisUtterance(expected);
      utterance.lang = "en-US";

      const selectedIndex = parseInt(document.getElementById("voiceSelect").value);
      if (voices[selectedIndex]) {
        utterance.voice = voices[selectedIndex];
      }

      speechSynthesis.speak(utterance);
    }

    function startListening() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        alert("TrÃ¬nh duyá»‡t cá»§a báº¡n khÃ´ng há»— trá»£ Speech Recognition.");
        return;
      }

      const recognition = new SpeechRecognition();
      recognition.lang = "en-US";
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.start();

      recognition.onresult = (event) => {
        const spoken = event.results[0][0].transcript.trim();
        lastSpoken = spoken; // lÆ°u láº¡i Ä‘á»ƒ phÃ¡t láº¡i
        document.getElementById("transcript").textContent = `ğŸ—£ï¸ Báº¡n nÃ³i: "${spoken}"`;

        const expected = dialogues[current].expected_answer.toLowerCase();
        const said = spoken.toLowerCase();

        if (said === expected) {
          document.getElementById("feedback").textContent = "âœ… ÄÃºng rá»“i!";
          document.getElementById("feedback").className = "correct";
          document.getElementById("soundCorrect").play(); // âœ… phÃ¡t Ã¢m Ä‘Ãºng
        } else {
          document.getElementById("feedback").textContent = `âŒ Sai. ÄÃ¡p Ã¡n Ä‘Ãºng: "${dialogues[current].expected_answer}"`;
          document.getElementById("feedback").className = "incorrect";
          document.getElementById("soundWrong").play();   // âŒ phÃ¡t Ã¢m sai
        }
      };

      recognition.onerror = () => {
        document.getElementById("feedback").textContent = "âŒ Lá»—i nháº­n diá»‡n giá»ng nÃ³i.";
        document.getElementById("feedback").className = "incorrect";
      };
            // === GHI Ã‚M GIá»ŒNG NGÆ¯á»œI DÃ™NG ===
        navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
            const mediaRecorder = new MediaRecorder(stream);
            const chunks = [];

            mediaRecorder.ondataavailable = e => chunks.push(e.data);
            mediaRecorder.onstop = () => {
            userAudioBlob = new Blob(chunks, { type: 'audio/webm' });
            const audioURL = URL.createObjectURL(userAudioBlob);
            const audio = document.getElementById("userAudio");
            audio.src = audioURL;
            audio.style.display = "block";
            };

            mediaRecorder.start();

            // Dá»«ng ghi sau 4 giÃ¢y (hoáº·c tuá»³)
            setTimeout(() => {
            mediaRecorder.stop();
            }, 4000);
        });
                // Hiá»ƒn thá»‹ tráº¡ng thÃ¡i ghi Ã¢m
        const statusElem = document.getElementById("recordingStatus");
        statusElem.textContent = "ğŸ”´ Äang ghi Ã¢m...";
        statusElem.classList.add("blinking");

        // Sau khi ghi Ã¢m xong thÃ¬ áº©n Ä‘i (sau 4 giÃ¢y)
        setTimeout(() => {
        statusElem.textContent = "";
        statusElem.classList.remove("blinking");
        }, 4000);

    }
    function playUserRecording() {
  const audio = document.getElementById("userAudio");
  if (userAudioBlob) {
    audio.play();
  } else {
    alert("ChÆ°a cÃ³ báº£n ghi Ã¢m nÃ o!");
  }
}
  </script>
</body>
</html>
