<!DOCTYPE html>
<html lang="vi">
<head>
Â  <meta charset="UTF-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  <title>ğŸ—£ï¸ Luyá»‡n phÃ¡t Ã¢m tá»« vá»±ng</title>
Â  <style>
Â  Â  body {
Â  Â  Â  font-family: 'Arial', sans-serif;
Â  Â  Â  padding: 20px;
Â  Â  Â  background: #f0f2f5; /* Light grey background */
Â  Â  Â  color: #333;
Â  Â  Â  line-height: 1.6;
Â  Â  }
Â  Â  h1 {
Â  Â  Â  text-align: center;
Â  Â  Â  color: #0056b3; /* Darker blue for headings */
Â  Â  Â  margin-bottom: 30px;
Â  Â  }
Â  Â  .controls-container {
Â  Â  Â  text-align: center;
Â  Â  Â  margin-bottom: 25px;
Â  Â  Â  padding: 15px;
Â  Â  Â  background-color: #e9f7ff; /* Light blue background for controls */
Â  Â  Â  border-radius: 8px;
Â  Â  Â  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
Â  Â  Â  max-width: 600px;
Â  Â  Â  margin-left: auto;
Â  Â  Â  margin-right: auto;
Â  Â  }
Â  Â  .controls-container label {
Â  Â  Â  margin-right: 10px;
Â  Â  Â  font-weight: bold;
Â  Â  Â  color: #333;
Â  Â  }
Â  Â  .controls-container select {
Â  Â  Â  padding: 8px 12px;
Â  Â  Â  border-radius: 5px;
Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  font-size: 1em;
Â  Â  Â  background-color: white;
Â  Â  Â  min-width: 150px;
Â  Â  }
Â  Â  .word-card {
Â  Â  Â  background: white;
Â  Â  Â  padding: 25px;
Â  Â  Â  margin: 20px auto; /* Centered with auto margins */
Â  Â  Â  border-radius: 10px;
Â  	  box-shadow: 0 4px 12px rgba(0,0,0,0.1); /* Softer shadow */
Â  	  max-width: 600px; /* Max width for readability */
Â  	}
Â  	.word-card h2 {
Â  	  margin: 0 0 5px 0;
Â  	  color: #007bff;
Â  	  font-size: 2.2em; /* Larger word */
Â  	  text-align: center;
Â  	}
    .word-details {
        text-align: center;
        margin-bottom: 15px;
        color: #666;
        font-size: 0.95em;
    }
    .word-details span {
        margin: 0 5px;
    }
    .word-details .part-of-speech {
        font-weight: bold;
        color: #555;
    }
    .word-details .phonetic {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* Font for IPA */
        font-weight: normal;
        color: #777;
        font-size: 0.9em;
    }
Â  	.word-card p {
Â  	  color: #555;
Â  	  font-size: 1.1em;
Â  	  text-align: center;
Â  	  margin-bottom: 20px;
Â  	  font-style: italic;
Â  	}
Â  	.buttons-container {
Â  	  display: flex;
Â  	  justify-content: center;
Â  	  gap: 15px; /* Space between buttons */
Â  	  margin-bottom: 15px;
Â  	}
Â  	button {
Â  	  padding: 10px 18px;
Â  	  border-radius: 25px; /* Pill-shaped buttons */
Â  	  border: none;
Â  	  background-color: #28a745; /* Green for action buttons */
Â  	  color: white;
Â  	  font-size: 1em;
Â  	  cursor: pointer;
Â  	  transition: background-color 0.3s ease, transform 0.2s ease;
Â  	  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
Â  	}
Â  	button:hover {
Â  	  background-color: #218838;
Â  	  transform: translateY(-1px);
Â  	}
Â  	button:active {
Â  	  transform: translateY(0);
Â  	}
Â  	button:disabled {
Â  	  background-color: #ccc;
Â  	  cursor: not-allowed;
Â  	}
Â  	.result {
Â  	  display: block;
Â  	  margin-top: 15px;
Â  	  font-weight: bold;
Â  	  font-size: 1.1em;
Â  	  text-align: center;
Â  	  min-height: 25px; /* Reserve space for feedback */
Â  	}
Â  	.correct {
Â  	  color: #28a745; /* Green for correct */
Â  	}
Â  	.incorrect {
Â  	  color: #dc3545; /* Red for incorrect */
Â  	}
Â  	.listening {
Â  	  color: #007bff; /* Blue for listening state */
Â  	}
Â  </style>
</head>
<body>
Â  <h1>ğŸ—£ï¸ Luyá»‡n phÃ¡t Ã¢m tá»« vá»±ng</h1>

Â  <div class="controls-container">
Â  Â  <label for="voice-select">Chá»n giá»ng Ä‘á»c:</label>
Â  Â  <select id="voice-select"></select>
Â  </div>

Â  <% words.forEach((entry, index) => { %>
Â  Â  <div class="word-card" data-word="<%= entry.word.toLowerCase() %>" data-english-word-original="<%= entry.word %>">
Â  Â  Â  <h2><%= entry.word %></h2>
        <div class="word-details">
            <% if (entry.part_of_speech_vn) { %>
                <span class="part-of-speech">(<%= entry.part_of_speech_vn %>)</span>
            <% } %>
            <% if (entry.phonetic_us) { %>
                <span class="phonetic"><%= entry.phonetic_us %></span>
            <% } %>
        </div>
Â  Â  Â  <p><%= entry.definitions[0].vietnamese %></p>
Â  Â  Â  <div class="buttons-container">
        <input type="hidden" class="expected-word" value="<%= entry.word %>">
Â  Â  Â  Â  <button class="speak-button" onclick="speakWord('<%= entry.word %>')">ğŸ”Š Nghe phÃ¡t Ã¢m</button>
Â  Â  Â  Â  <button class="record-button" onclick="recordAndSend(this)">ğŸ™ï¸ NÃ³i thá»­</button>
Â  Â  Â  </div>
Â  Â  Â  <span class="result"></span>
Â  Â  </div>
Â  <% }) %>

Â  <script>
Â  Â  const synth = window.speechSynthesis;
Â  Â  let voices = [];
Â  Â  let selectedVoice = null;
Â  Â  const voiceSelect = document.getElementById('voice-select');

Â  Â  // HÃ m chuáº©n hÃ³a chuá»—i Ä‘á»ƒ so sÃ¡nh: loáº¡i bá» dáº¥u cÃ¢u, chuyá»ƒn vá» chá»¯ thÆ°á»ng, bá» khoáº£ng tráº¯ng thá»«a
Â  Â  function normalizeString(str) {
Â  Â  Â  if (typeof str !== 'string') return '';
Â  Â  Â  return str
Â  Â  Â  Â  .replace(/[^\p{L}\p{N}\s]/gu, '') // Loáº¡i bá» táº¥t cáº£ kÃ½ tá»± khÃ´ng pháº£i chá»¯ cÃ¡i (Unicode), sá»‘, vÃ  khoáº£ng tráº¯ng
Â  Â  Â  Â  .replace(/\s+/g, ' ') // Thay tháº¿ nhiá»u khoáº£ng tráº¯ng thÃ nh má»™t
Â  Â  Â  Â  .toLowerCase()
Â  Â  Â  Â  .trim();
Â  Â  }

/* Â  Â  // Populate voice dropdown
Â  Â  function populateVoiceList() {
Â  Â  Â  voices = synth.getVoices().sort((a, b) => a.name.localeCompare(b.name));
Â  Â  Â  voiceSelect.innerHTML = ''; // Clear existing options

Â  Â  Â  const defaultOption = document.createElement('option');
Â  Â  Â  defaultOption.textContent = 'Máº·c Ä‘á»‹nh (TrÃ¬nh duyá»‡t)';
Â  Â  Â  defaultOption.value = '';
Â  Â  Â  voiceSelect.appendChild(defaultOption);

Â  Â  Â  let foundPreferredVoice = false;
Â  Â  Â  for (let i = 0; i < voices.length; i++) {
Â  Â  Â  Â  // Chá»‰ thÃªm cÃ¡c giá»ng tiáº¿ng Anh
Â  Â  Â  Â  if (voices[i].lang.startsWith('en')) {
Â  Â  Â  Â  Â  const option = document.createElement('option');
Â  Â  Â  Â  Â  option.textContent = voices[i].name + ' (' + voices[i].lang + ')';
Â  Â  Â  Â  Â  option.value = voices[i].name;

Â  Â  Â  Â  Â  // Æ¯u tiÃªn chá»n giá»ng Google US English
Â  Â  Â  Â  Â  if (voices[i].name.includes('Google US English') && (voices[i].name.includes('Female') || voices[i].name.includes('Male'))) {
Â  Â  Â  Â  Â  Â  if (!foundPreferredVoice) {
Â  Â  Â  Â  Â  Â  Â  option.selected = true;
Â  Â  Â  Â  Â  Â  Â  selectedVoice = voices[i];
Â  Â  Â  Â  Â  Â  Â  foundPreferredVoice = true;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  voiceSelect.appendChild(option);
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  // Náº¿u khÃ´ng tÃ¬m tháº¥y giá»ng Æ°u tiÃªn, cá»‘ gáº¯ng chá»n báº¥t ká»³ giá»ng tiáº¿ng Anh nÃ o lÃ m máº·c Ä‘á»‹nh
Â  Â  Â  if (!selectedVoice && voices.length > 0) {
Â  Â  Â  Â  selectedVoice = voices.find(voice => voice.lang.startsWith('en'));
Â  Â  Â  Â  if (selectedVoice) {
Â  Â  Â  Â  Â  voiceSelect.value = selectedVoice.name;
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  } */

function populateVoiceList() {
  voices = synth.getVoices();
  voiceSelect.innerHTML = '';

  const defaultOption = document.createElement('option');
  defaultOption.textContent = 'Máº·c Ä‘á»‹nh (TrÃ¬nh duyá»‡t)';
  defaultOption.value = '';
  voiceSelect.appendChild(defaultOption);

  voices.forEach(voice => {
    // âš ï¸ Kiá»ƒm tra xem voice thá»±c sá»± cÃ³ thá»ƒ sá»­ dá»¥ng
    if (voice.lang.startsWith('en') && voice.default || voice.localService) {
      const option = document.createElement('option');
      option.textContent = `${voice.name} (${voice.lang})`;
      option.value = voice.name;
      voiceSelect.appendChild(option);
    }
  });

  selectedVoice = voices.find(v => v.name === voiceSelect.value);
}
Â  Â  // Load voices when they change (some browsers load them asynchronously)
Â  Â  if (synth.getVoices().length === 0) {
Â  Â  Â  synth.onvoiceschanged = populateVoiceList;
Â  Â  } else {
Â  Â  Â  populateVoiceList();
Â  Â  }


Â  Â  // Update selected voice when user changes dropdown
Â  Â  voiceSelect.addEventListener('change', () => {
  const selectedVoiceName = voiceSelect.value;
  selectedVoice = voices.find(voice => voice.name === selectedVoiceName) || null;
});

Â  Â  // Function to speak the word
/* Â  Â  function speakWord(text) {
Â  Â  Â  if (synth.speaking) { // If already speaking, stop current speech
Â  Â  Â  Â  synth.cancel();
Â  Â  Â  }
Â  Â  Â  const utterance = new SpeechSynthesisUtterance(text);
Â  Â  Â  utterance.lang = 'en-US'; // Always try to speak in US English
Â  Â  Â  if (selectedVoice) {
Â  Â  Â  Â  utterance.voice = selectedVoice;
Â  Â  Â  } else {
Â  Â  Â  Â  // Fallback if no specific voice is selected or found
Â  Â  Â  Â  utterance.voice = voices.find(voice => voice.lang === 'en-US') || null;
Â  Â  Â  }
Â  Â  Â  synth.speak(utterance);
Â  Â  } */
    /* async function speakWord(word) {
        const response = await fetch('/tts/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ word })
        });
        const data = await response.json();
        if (data.url) {
            const audio = new Audio(data.url);
            audio.play();
        } else {
            alert('KhÃ´ng phÃ¡t Ä‘Æ°á»£c Ã¢m thanh: ' + data.error);
        }
        }
Â  Â   */

    async function speakWord(word) {
    const selectedVoiceName = voiceSelect.value || 'en-US-AriaNeural';

    const response = await fetch('/tts/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ word, voice: selectedVoiceName })
    });

    const data = await response.json();
    if (data.url) {
        const audio = new Audio(data.url);
        audio.play();
    } else {
        alert('KhÃ´ng phÃ¡t Ä‘Æ°á»£c Ã¢m thanh: ' + (data.error || 'KhÃ´ng rÃµ lá»—i.'));
    }
}

                // Function to start speech recognition
Â  Â  function startRecognition(button) {
Â  Â  Â  if (!('webkitSpeechRecognition' in window)) {
Â  Â  Â  Â  alert('TrÃ¬nh duyá»‡t cá»§a báº¡n khÃ´ng há»— trá»£ Speech Recognition. Vui lÃ²ng sá»­ dá»¥ng Chrome hoáº·c trÃ¬nh duyá»‡t há»— trá»£ khÃ¡c.');
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  const recognition = new webkitSpeechRecognition();
Â  Â  Â  recognition.lang = 'en-US'; // Set recognition language to English
Â  Â  Â  recognition.interimResults = false;
Â  Â  Â  recognition.maxAlternatives = 1;

Â  Â  Â  const card = button.closest('.word-card');
Â  Â  Â  // Láº¥y tá»« tiáº¿ng Anh gá»‘c vÃ  chuáº©n hÃ³a nÃ³
Â  Â  Â  const originalEnglishWord = card.getAttribute('data-english-word-original');
Â  Â  Â  const normalizedCorrectWord = normalizeString(originalEnglishWord);

Â  	  const resultElem = card.querySelector('.result');
Â  	  const recordButton = card.querySelector('.record-button');
Â  	  const speakButton = card.querySelector('.speak-button');

Â  	  // Disable buttons during recognition
Â  	  recordButton.disabled = true;
Â  	  speakButton.disabled = true;
Â  	  resultElem.textContent = 'Äang láº¯ng nghe...';
Â  	  resultElem.className = 'result listening';

Â  	  recognition.onresult = (event) => {
Â  	  Â  const spokenRaw = event.results[0][0].transcript; // Giá»¯ nguyÃªn báº£n gá»‘c Ä‘á»ƒ hiá»ƒn thá»‹
Â  	  Â  const spokenNormalized = normalizeString(spokenRaw); // Báº£n chuáº©n hÃ³a Ä‘á»ƒ so sÃ¡nh
Â  	  Â  const confidence = event.results[0][0].confidence;

Â  	  Â  // Check if the normalized spoken word matches the normalized correct word
Â  	  Â  if (spokenNormalized === normalizedCorrectWord) {
Â  	  Â  Â  resultElem.textContent = `âœ… ChÃ­nh xÃ¡c! Báº¡n nÃ³i: "${spokenRaw}" (Äá»™ tin cáº­y: ${Math.round(confidence * 100)}%)`;
Â  	  Â  Â  resultElem.className = 'result correct';
Â  	  Â  } else {
Â  	  Â  Â  resultElem.textContent = `âŒ ChÆ°a Ä‘Ãºng. Báº¡n nÃ³i: "${spokenRaw}" (Äá»™ tin cáº­y: ${Math.round(confidence * 100)}%). Tá»« Ä‘Ãºng lÃ : "${originalEnglishWord}"`;
Â  	  Â  Â  resultElem.className = 'result incorrect';
Â  	  Â  }
Â  	  Â  // Re-enable buttons after result
Â  	  Â  recordButton.disabled = false;
Â  	  Â  speakButton.disabled = false;
Â  	  };

Â  	  recognition.onerror = (event) => {
Â  	  Â  let errorMessage = 'Lá»—i ghi Ã¢m khÃ´ng xÃ¡c Ä‘á»‹nh.';
Â  	  Â  if (event.error === 'not-allowed') {
Â  	  Â  Â  errorMessage = 'Lá»—i: Báº¡n Ä‘Ã£ tá»« chá»‘i quyá»n truy cáº­p microphone. Vui lÃ²ng cáº¥p quyá»n trong cÃ i Ä‘áº·t trÃ¬nh duyá»‡t vÃ  táº£i láº¡i trang.';
Â  	  Â  } else if (event.error === 'no-speech') {
Â  	  Â  Â  errorMessage = 'KhÃ´ng nghe tháº¥y giá»ng nÃ³i. Vui lÃ²ng nÃ³i rÃµ hÆ¡n.';
Â  	  Â  } else if (event.error === 'aborted') {
Â  	  Â  Â  errorMessage = 'Ghi Ã¢m bá»‹ há»§y.';
Â  	  Â  } else if (event.error === 'audio-capture') {
Â  	  Â  Â  errorMessage = 'Lá»—i thu Ã¢m thanh. Kiá»ƒm tra microphone cá»§a báº¡n.';
Â  	  Â  } else if (event.error === 'network') {
Â  	  Â  Â  errorMessage = 'Lá»—i máº¡ng khi ghi Ã¢m. Kiá»ƒm tra káº¿t ná»‘i internet.';
Â  	  Â  } else if (event.error === 'service-not-allowed') {
Â  	  Â  Â  errorMessage = 'Dá»‹ch vá»¥ ghi Ã¢m khÃ´ng Ä‘Æ°á»£c phÃ©p (cÃ³ thá»ƒ do HTTPS).';
Â  	  Â  } else {
Â  	  Â  Â  errorMessage = `Lá»—i ghi Ã¢m: ${event.error}. Vui lÃ²ng thá»­ láº¡i.`;
Â  	  Â  }
Â  	  Â  resultElem.textContent = errorMessage;
Â  	  Â  resultElem.className = 'result incorrect';
Â  	  Â  // Re-enable buttons on error
Â  	  Â  recordButton.disabled = false;
Â  	  Â  speakButton.disabled = false;
Â  	  };

Â  	  recognition.onend = () => {
Â  	  Â  // Ensure buttons are re-enabled even if onresult/onerror didn't fire for some reason
Â  	  Â  recordButton.disabled = false;
Â  	  Â  speakButton.disabled = false;
Â  	  };

Â  	  recognition.start();
Â  	}
    async function recordAndSend(button) {
    try {
      const card = button.closest(".word-card");
      const expectedWord = card.querySelector(".expected-word").value;
      const resultElem = card.querySelector(".result");
      const recordButton = card.querySelector(".record-button");
      const speakButton = card.querySelector(".speak-button");

      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ ghi Ã¢m.");
        return;
      }

      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const mediaRecorder = new MediaRecorder(stream);
      const audioChunks = [];

      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        const formData = new FormData();
        formData.append('audio', audioBlob, 'voice.wav');
        formData.append('expected', expectedWord);

        resultElem.textContent = "â³ Äang gá»­i vÃ  xá»­ lÃ½...";
        resultElem.className = "result listening";
        recordButton.disabled = true;
        speakButton.disabled = true;

        try {
          const res = await fetch('/pronounce/upload', {
            method: 'POST',
            body: formData
          });

          const data = await res.json();
          if (data.error) {
            resultElem.textContent = `âŒ Lá»—i: ${data.error}`;
            resultElem.className = "result incorrect";
          } else {
            const correct = data.isCorrect;
const feedback = data.feedback || (correct ? "âœ… ChÃ­nh xÃ¡c!" : "âŒ ChÆ°a Ä‘Ãºng.");
resultElem.textContent =
  `${feedback}\n(Äiá»ƒm: ${data.score}/100)\nBáº¡n nÃ³i: "${data.userSaid}"\nTá»« Ä‘Ãºng lÃ : "${data.expected}"`;
resultElem.className = "result " + (correct ? "correct" : "incorrect");



            resultElem.className = "result " + (correct ? "correct" : "incorrect");
          }
        } catch (err) {
          resultElem.textContent = "âŒ Gá»­i tháº¥t báº¡i: " + err.message;
          resultElem.className = "result incorrect";
        }

        recordButton.disabled = false;
        speakButton.disabled = false;
      };

      mediaRecorder.start();
      resultElem.textContent = "ğŸ¤ Äang ghi Ã¢m trong 4 giÃ¢y...";
      setTimeout(() => mediaRecorder.stop(), 4000);

    } catch (err) {
      alert("Lá»—i ghi Ã¢m: " + err.message);
    }
  }
Â  </script>
</body>
</html>