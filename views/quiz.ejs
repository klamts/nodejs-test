<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title><%= video.title %></title>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f0f2f5;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    h1, h2 {
      color: #333;
      margin-bottom: 15px;
      text-align: center;
    }
.sticky-question {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #f8f9fa;
  border: 1px solid #ddd;
  padding: 15px;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  max-width: 300px;
  z-index: 1000;
  display: none;
}
.sticky-question.show {
  display: block;
}
    #quiz-container {
      display: none;
      position: fixed; /* Changed to fixed for better overlay behavior */
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%; /* Responsive width */
      max-width: 600px; /* Max width for larger screens */
      background: rgba(255,255,255,0.98); /* Slightly more opaque */
      border: 2px solid #007bff; /* Blue border for a modern look */
      padding: 25px;
      border-radius: 15px; /* More rounded corners */
      text-align: center;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2); /* Stronger shadow */
      z-index: 10;
      animation: fadeIn 0.5s ease-out; /* Fade in animation */
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translate(-50%, -60%); }
      to { opacity: 1; transform: translate(-50%, -50%); }
    }

    #quiz-container button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 8px; /* Increased margin */
      border-radius: 8px; /* Rounded buttons */
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    #quiz-container button:hover {
      background-color: #0056b3;
      transform: translateY(-2px); /* Slight lift on hover */
      box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    }

    #quiz-container button:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    video {
      width: 100%;
      max-width: 800px;
      margin-top: 10px;
      border-radius: 10px; /* Rounded video player */
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    input[type="text"], select {
      width: calc(80% - 10px); /* Adjust width for padding */
      padding: 10px; /* Increased padding */
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
    }

    #answers img {
      max-width: 100px;
      height: auto;
      border: 2px solid transparent;
      border-radius: 8px;
      margin: 10px;
      cursor: pointer;
      transition: transform 0.2s, border-color 0.2s;
    }

    #answers img:hover {
      transform: scale(1.05);
      border-color: #007bff;
    }

    #feedback {
      font-weight: bold;
      margin-top: 15px;
      font-size: 1.1em;
    }

    /* Answer History Section */
    #history {
      position: fixed; /* Changed to fixed */
      top: 20px;
      right: 20px;
      width: 300px;
      max-height: calc(100vh - 40px); /* Adjust max-height */
      overflow-y: auto;
      background: #f9f9f9;
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      z-index: 5;
    }
    #history h3 {
      margin-top: 0;
      color: #555;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
      margin-bottom: 15px;
    }
    #history-list {
      list-style-type: none;
      padding-left: 0;
    }
    #history-list li {
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid #ddd;
      font-size: 0.9em;
      line-height: 1.4;
    }
    #history-list li:last-child {
      border-bottom: none;
    }
    #history-list strong {
      color: #444;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      #quiz-container {
        width: 90%;
        padding: 15px;
      }
      #history {
        position: static; /* Stack on smaller screens */
        width: 90%;
        max-width: none;
        margin-top: 20px;
        left: auto;
        right: auto;
        transform: none;
      }
      body {
        flex-direction: column;
        align-items: center;
      }
    }

    /* Style for the speaker icon button */
    .speaker-button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.5em; /* Adjust size as needed */
      color: #007bff;
      margin-left: 10px;
      vertical-align: middle;
      padding: 0;
      transition: color 0.2s ease;
    }

    .speaker-button:hover {
      color: #0056b3;
    }

    /* Style for voice selection dropdown */
    #voice-select-container {
      margin-bottom: 20px;
      text-align: center;
    }
    #voice-select {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 1em;
    }

    /* Style for pronunciation check status */
    #pronunciation-status {
      margin-top: 10px;
      font-style: italic;
      color: #555;
    }
  </style>
</head>
<body>

  
  <h1>Interactive Video Quiz</h1>
  
  <h2><%= video.title %></h2>

  <div id="voice-select-container">
    <label for="voice-select">Select Voice:</label>
    <select id="voice-select"></select>
  </div>
  <div style="margin-bottom: 15px; text-align: center;">
  <label>
    <input type="checkbox" id="toggle-quiz" checked />
    Báº­t cÃ¢u há»i tÆ°Æ¡ng tÃ¡c
  </label>
</div>
<!-- Sticky pronunciation quiz -->
<div id="stickyQuestion" class="sticky-question">
  <h5>CÃ¢u há»i: Äá»c cÃ¢u sau</h5>
  <p id="sentenceText"></p>
  <input type="hidden" id="expectedSentence">
  <button id="recordBtn" class="record-btn">Ghi Ã¢m</button>
  <button id="skipBtn" class="skip-btn">Bá» qua</button>
  <div id="feedback" class="feedback"></div>
</div>

  <div style="position: relative; width: 100%; max-width: 800px;">
    <video id="myVideo" controls>
      <source src="<%= videoPath %>" type="video/mp4">
    </video>
    <div id="quiz-container">
      <p id="question-text"><strong>Question:</strong></p>
      <div id="answers"></div>
      <p id="feedback"></p>
      <p id="status"></p>
      <p id="result"></p>
      <p id="pronunciation-status"></p> </div>
  </div>

  <div id="timeDisplay">Current Video Time: 0:00</div>

  <div id="history">
    <h3>Answer History</h3>
    <ul id="history-list"></ul>
  </div>
  <a href="/practice-pronunciation" style="padding: 10px 20px; background-color: #17a2b8; color: white; text-decoration: none; border-radius: 6px;">
    ğŸ—£ï¸ Luyá»‡n phÃ¡t Ã¢m tá»« vá»±ng
  </a>
  <a href="/game/word-assemble" style="padding: 10px 20px; background-color: #28a745; color: white; text-decoration: none; border-radius: 6px;">
    ğŸ® TrÃ² chÆ¡i ghÃ©p tá»«
  </a>
  <a href="/game/context-clue" style="padding: 10px 20px; background-color: #28a745; color: white; text-decoration: none; border-radius: 6px;">
    ğŸ® TrÃ² chÆ¡i Ä‘oÃ¡n tá»« qua ngá»¯ cáº£nh
  </a>
  <a href="/game/match-word-meaning" style="padding: 10px 20px; background-color: #28a745; color: white; text-decoration: none; border-radius: 6px;">
    ğŸ® TrÃ² chÆ¡i ná»‘i tá»« vá»›i nghÄ©a tiáº¿ng Viá»‡t
  </a>
  <a href="/question/<%= video.subject_id %>">ğŸ¯ LÃ m bÃ i Quiz tÆ°Æ¡ng tÃ¡c</a>
  <a href="/practice-questionanswer">ğŸ®Há»i Ä‘Ã¡p tiáº¿ng anh </a>
  
  Â  <script>
Â  Â  const video = document.getElementById('myVideo');
Â  Â  const quizContainer = document.getElementById('quiz-container');
Â  Â  const questionText = document.getElementById('question-text');
Â  Â  const answersContainer = document.getElementById('answers');
Â  Â  const feedback = document.getElementById('feedback');
Â  Â  const timeDisplay = document.getElementById('timeDisplay');
Â  Â  const historyList = document.getElementById('history-list');
Â  Â  const voiceSelect = document.getElementById('voice-select');
Â  Â  const pronunciationStatus = document.getElementById('pronunciation-status');

Â  Â  // Khá»Ÿi táº¡o SpeechSynthesis vÃ  SpeechRecognition
Â  Â  const synth = window.speechSynthesis;
Â  Â  let voices = [];
Â  Â  let selectedVoice = null;

Â  Â  // Kiá»ƒm tra há»— trá»£ SpeechRecognition
Â  Â  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
Â  Â  let recognition = null;
Â  Â  let isRecording = false;

Â  Â  // Láº¥y dá»¯ liá»‡u quiz tá»« server
Â  Â  const rawData = <%- JSON.stringify(quizData) %>;
Â  Â  const quizQuestions = [];

Â  Â  // HÃ m trá»£ giÃºp Ä‘á»ƒ láº¥y thuá»™c tÃ­nh lá»“ng nhau tá»« Ä‘á»‘i tÆ°á»£ng
Â  Â  function getNestedProperty(obj, path) {
Â  Â  Â  Â  return path.split('.').reduce((o, key) => {
Â  Â  Â  Â  Â  Â  if (o && typeof o === 'object') {
Â  Â  Â  Â  Â  Â  Â  Â  const arrayMatch = key.match(/(\w+)\[(\d+)\]/);
Â  Â  Â  Â  Â  Â  Â  Â  if (arrayMatch) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const arrayName = arrayMatch[1];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const index = parseInt(arrayMatch[2], 10);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return o[arrayName] ? o[arrayName][index] : undefined;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return o[key];
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return undefined;
Â  Â  Â  Â  }, obj);
Â  Â  }

Â  Â  // HÃ m chuáº©n hÃ³a chuá»—i tiáº¿ng Viá»‡t (xÃ³a dáº¥u, chuyá»ƒn chá»¯ thÆ°á»ng, bá» khoáº£ng tráº¯ng)
Â  Â  function normalizeVN(str) {
Â  Â  Â  if (typeof str !== 'string') return ''; 
Â  Â  Â  return str
Â  Â  Â  Â  .normalize("NFD")
Â  Â  Â  Â  .replace(/[\u0300-\u036f]/g, "")
Â  Â  Â  Â  .replace(/Ä‘/g, "d")
Â  Â  Â  Â  .replace(/Ä/g, "D")
Â  Â  Â  Â  .toLowerCase()
Â  Â  Â  Â  .trim();
Â  Â  }

Â  Â  // HÃ m chuáº©n hÃ³a chuá»—i tiáº¿ng Anh (chuyá»ƒn chá»¯ thÆ°á»ng, bá» khoáº£ng tráº¯ng)
Â  Â  function normalizeEN(str) {
Â  Â  Â  Â  if (typeof str !== 'string') return '';
Â  Â  Â  Â  return str.toLowerCase().trim();
Â  Â  }

Â  Â  // HÃ m Ä‘á»‹nh dáº¡ng thá»i gian tá»« giÃ¢y sang MM:SS
Â  Â  function formatTime(seconds) {
Â  Â  Â  const min = Math.floor(seconds / 60);
Â  Â  Â  const sec = Math.floor(seconds % 60);
Â  Â  Â  return `${min}:${sec < 10 ? '0' + sec : sec}`;
Â  Â  }

Â  Â  // Populate quizQuestions array from rawData
Â  Â  rawData.forEach(entry => {
Â  Â  Â  Â  entry.quiz_questions.forEach(q => {
Â  Â  Â  Â  Â  Â  q.timestamps.forEach(ts => {
Â  Â  Â  Â  Â  Â  Â  Â  const match = ts.match(/(\d+):(\d+):(\d+),(\d+)/); 
Â  Â  Â  Â  Â  Â  Â  Â  if (match) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const [, h, m, s, ms] = match.map(Number);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const timeInSeconds = h * 3600 + m * 60 + s + ms / 1000;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let correctAnswer; // Normalized for comparison
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let displayCorrectAnswer; // Original for display
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let englishWordForPronunciation = entry.word; // Default to entry.word
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let options = q.options || []; // DÃ²ng nÃ y quan trá»ng: Khá»Ÿi táº¡o options tá»« q.options

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (q.type === 'multiple_choice_meaning_vn') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  correctAnswer = normalizeVN(q.correct_answer_text || "");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayCorrectAnswer = q.correct_answer_text || ""; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // options = (q.options || []); // DÃ²ng nÃ y cÃ³ thá»ƒ xÃ³a náº¿u Ä‘Ã£ khai bÃ¡o á»Ÿ trÃªn
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (q.type === 'copy_word') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  correctAnswer = normalizeVN(entry.word).repeat(3);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayCorrectAnswer = entry.word.repeat(3); 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (q.type === 'example_vn_fill_blank') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  correctAnswer = normalizeVN(entry.word);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayCorrectAnswer = entry.word; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (q.type === 'part_of_speech_vn') { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  correctAnswer = normalizeVN(entry.part_of_speech_vn);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayCorrectAnswer = entry.part_of_speech_vn;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (q.type === 'pronunciation_check') { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  correctAnswer = normalizeEN(entry.word); 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayCorrectAnswer = entry.word; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (q.type === 'translate_sentence_en_to_vn') { // Xá»­ lÃ½ loáº¡i cÃ¢u há»i dá»‹ch cÃ¢u
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  englishWordForPronunciation = q.english_sentence || ""; // Sá»­ dá»¥ng cÃ¢u tiáº¿ng Anh Ä‘áº§y Ä‘á»§ Ä‘á»ƒ phÃ¡t Ã¢m
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  correctAnswer = normalizeVN(q.correct_answer_text || "");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayCorrectAnswer = q.correct_answer_text || "";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // options = (q.options || []); // DÃ²ng nÃ y cÃ³ thá»ƒ xÃ³a náº¿u Ä‘Ã£ khai bÃ¡o á»Ÿ trÃªn
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (q.answer_source_field) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const originalValue = getNestedProperty(entry, q.answer_source_field);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  correctAnswer = normalizeVN(originalValue);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayCorrectAnswer = originalValue; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error(`Error getting answer for ${entry.word} from ${q.answer_source_field}:`, e);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  correctAnswer = "";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayCorrectAnswer = "";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  correctAnswer = ""; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayCorrectAnswer = "";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quizQuestions.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  time: timeInSeconds,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  type: q.type,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  question: q.question_template
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .replace('{word}', entry.word)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .replace('{part_of_speech}', entry.part_of_speech)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .replace('{part_of_speech_vn}', entry.part_of_speech_vn)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .replace('{english_sentence}', q.english_sentence || ''), // Sá»­ dá»¥ng q.english_sentence trá»±c tiáº¿p
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  correctAnswer: correctAnswer, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayCorrectAnswer: displayCorrectAnswer, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  options: options, // Äáº£m báº£o options Ä‘Æ°á»£c Ä‘Æ°a vÃ o Ä‘Ã¢y
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  englishWordForPronunciation: englishWordForPronunciation 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  });

Â  Â  quizQuestions.sort((a, b) => a.time - b.time);

Â  Â  // Populate voice dropdown
Â  Â  function populateVoiceList() {
Â  Â  Â  voices = synth.getVoices().sort((a, b) => a.name.localeCompare(b.name));
Â  Â  Â  voiceSelect.innerHTML = ''; 

Â  Â  Â  const defaultOption = document.createElement('option');
Â  Â  Â  defaultOption.textContent = 'Default (Browser)';
Â  Â  Â  defaultOption.value = '';
Â  Â  Â  voiceSelect.appendChild(defaultOption);

Â  Â  Â  for (let i = 0; i < voices.length; i++) {
Â  Â  Â  Â  if (voices[i].lang.startsWith('en')) { 
Â  Â  Â  Â  Â  const option = document.createElement('option');
Â  Â  Â  Â  Â  option.textContent = voices[i].name + ' (' + voices[i].lang + ')';
Â  Â  Â  Â  Â  option.value = voices[i].name; 
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  if (voices[i].name.includes('Google US English') && voices[i].name.includes('Female')) {
Â  Â  Â  Â  Â  Â  option.selected = true;
Â  Â  Â  Â  Â  Â  selectedVoice = voices[i];
Â  Â  Â  Â  Â  } else if (voices[i].name.includes('Google US English') && voices[i].name.includes('Male') && !selectedVoice) {
Â  Â  Â  Â  Â  Â  option.selected = true;
Â  Â  Â  Â  Â  Â  selectedVoice = voices[i];
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  voiceSelect.appendChild(option);
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  if (!selectedVoice && voices.length > 0) {
Â  Â  Â  Â  selectedVoice = voices.find(voice => voice.lang.startsWith('en'));
Â  Â  Â  Â  if (selectedVoice) {
Â  Â  Â  Â  Â  Â  voiceSelect.value = selectedVoice.name;
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }

Â  Â  populateVoiceList();
Â  Â  if (synth.onvoiceschanged !== undefined) {
Â  Â  Â  synth.onvoiceschanged = populateVoiceList;
Â  Â  }

Â  Â  voiceSelect.addEventListener('change', () => {
Â  Â  Â  const selectedVoiceName = voiceSelect.value;
Â  Â  Â  selectedVoice = voices.find(voice => voice.name === selectedVoiceName);
Â  Â  });

Â  Â  function speakEnglishWord(word) {
Â  Â  Â  if ('speechSynthesis' in window) {
Â  Â  Â  Â  const utterance = new SpeechSynthesisUtterance(word);
Â  Â  Â  Â  utterance.lang = 'en-US'; 
Â  Â  Â  Â  if (selectedVoice) {
Â  Â  Â  Â  Â  utterance.voice = selectedVoice; 
Â  Â  Â  Â  }
Â  Â  Â  Â  synth.speak(utterance);
Â  Â  Â  } else {
Â  Â  Â  Â  console.warn('SpeechSynthesis API not supported in this browser.');
Â  Â  Â  }
Â  Â  }

Â  Â  let currentQuestionIndex = -1;
Â  Â  const shownQuestions = new Set();

Â  Â  video.addEventListener('seeked', () => {
Â  Â  Â  const currentTime = video.currentTime;
Â  Â  Â  const questionsToRemove = [];
Â  Â  Â  for (let index of shownQuestions) {
Â  Â  Â  Â  if (quizQuestions[index].time > currentTime) {
Â  Â  Â  Â  Â  questionsToRemove.push(index);
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  questionsToRemove.forEach(index => shownQuestions.delete(index));
Â  Â  Â  resetQuizUI();
Â  Â  });

Â  Â  video.addEventListener('timeupdate', () => {
  const currentTime = video.currentTime;
  const quizEnabled = document.getElementById('toggle-quiz')?.checked;

  if (!quizEnabled) return; // KhÃ´ng hiá»ƒn thá»‹ cÃ¢u há»i náº¿u ngÆ°á»i dÃ¹ng táº¯t

  for (let i = 0; i < quizQuestions.length; i++) {
    const q = quizQuestions[i];
    if (currentTime >= q.time && !shownQuestions.has(i)) {
      video.pause(); 
      currentQuestionIndex = i;
      showQuestion(q); 
      shownQuestions.add(i); 
      break; 
    }
  }
});

Â  Â  function resetQuizUI() {
Â  Â  Â  answersContainer.innerHTML = '';
Â  Â  Â  feedback.textContent = '';
Â  Â  Â  pronunciationStatus.textContent = ''; 
Â  Â  Â  document.getElementById('status').innerText = '';
Â  Â  Â  document.getElementById('result').innerText = '';
Â  Â  Â  quizContainer.style.display = 'none';
Â  Â  }

Â  Â  function startRecording(targetWord) {
Â  Â  Â  if (!SpeechRecognition) {
Â  Â  Â  Â  pronunciationStatus.textContent = "Speech Recognition not supported in this browser.";
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  recognition = new SpeechRecognition();
Â  Â  Â  recognition.lang = 'en-US'; 
Â  Â  Â  recognition.interimResults = false; 
Â  Â  Â  recognition.maxAlternatives = 1; 

Â  Â  Â  recognition.onstart = () => {
Â  Â  Â  Â  isRecording = true;
Â  Â  Â  Â  pronunciationStatus.textContent = "Listening... Please say: '" + targetWord + "'";
Â  Â  Â  Â  answersContainer.querySelectorAll('button').forEach(btn => btn.disabled = true);
Â  Â  Â  };

Â  Â  Â  recognition.onresult = (event) => {
Â  Â  Â  Â  const transcript = event.results[0][0].transcript;
Â  Â  Â  Â  const confidence = event.results[0][0].confidence;
Â  Â  Â  Â  pronunciationStatus.textContent = `You said: "${transcript}" (Confidence: ${Math.round(confidence * 100)}%)`;
Â  Â  Â  Â  checkPronunciation(transcript, targetWord); 
Â  Â  Â  };

Â  Â  Â  recognition.onerror = (event) => {
Â  Â  Â  Â  isRecording = false;
Â  Â  Â  Â  pronunciationStatus.textContent = "Error: " + event.error;
Â  Â  Â  Â  answersContainer.querySelectorAll('button').forEach(btn => btn.disabled = false);
Â  Â  Â  Â  console.error("Speech Recognition Error:", event.error);
Â  Â  Â  };

Â  Â  Â  recognition.onend = () => {
Â  Â  Â  Â  isRecording = false;
Â  Â  Â  Â  if (!feedback.textContent) { 
Â  Â  Â  Â  Â  Â  pronunciationStatus.textContent += " (Recording ended)";
Â  Â  Â  Â  }
Â  Â  Â  Â  answersContainer.querySelectorAll('button').forEach(btn => btn.disabled = false);
Â  Â  Â  };

Â  Â  Â  recognition.start();
Â  Â  }

Â  Â  function stopRecording() {
Â  Â  Â  if (recognition && isRecording) {
Â  Â  Â  Â  recognition.stop();
Â  Â  Â  Â  isRecording = false;
Â  Â  Â  }
Â  Â  }

Â  Â  function checkPronunciation(userTranscript, targetWord) {
Â  Â  Â  Â  const normalizedUser = normalizeEN(userTranscript);
Â  Â  Â  Â  const normalizedTarget = normalizeEN(targetWord);

Â  Â  Â  Â  let correct = normalizedUser === normalizedTarget;

Â  Â  Â  Â  feedback.textContent = correct ? "âœ… Correct pronunciation!" : `âŒ Incorrect pronunciation. Expected: "${targetWord}"`;

Â  Â  Â  Â  const listItem = document.createElement('li');
Â  Â  Â  Â  listItem.innerHTML = 
Â  Â  Â  Â  Â  Â  `<strong>Question:</strong> Pronounce '${targetWord}'<br>
Â  Â  Â  Â  Â  Â  <strong>Your Pronunciation:</strong> ${userTranscript}<br>
Â  Â  Â  Â  Â  Â  <strong>Result:</strong> ${correct ? 'âœ… Correct' : `âŒ Incorrect (Expected: ${targetWord})`}`;
Â  Â  Â  Â  historyList.appendChild(listItem);
Â  Â  Â  Â  historyList.scrollTop = historyList.scrollHeight;

Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  quizContainer.style.display = 'none';
Â  Â  Â  Â  Â  Â  feedback.textContent = "";
Â  Â  Â  Â  Â  Â  pronunciationStatus.textContent = "";
Â  Â  Â  Â  Â  Â  video.play();
Â  Â  Â  Â  }, 2000);
Â  Â  }

Â  Â  function showQuestion(question) {
Â  Â  Â  const questionSpan = document.createElement('span');
Â  Â  Â  // Äiá»u chá»‰nh cÃ¢u há»i hiá»ƒn thá»‹ cho translate_sentence_en_to_vn
Â  Â  Â  if (question.type === 'translate_sentence_en_to_vn') {
Â  Â  Â  Â  questionSpan.innerHTML = `<strong>Translate to Vietnamese:</strong> "${question.englishWordForPronunciation}"`;
Â  Â  Â  } else {
Â  Â  Â  Â  questionSpan.innerHTML = `<strong>Question:</strong> ${question.question || ''}`;
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  const speakerButton = document.createElement('button');
Â  Â  Â  speakerButton.className = 'speaker-button';
Â  Â  Â  speakerButton.innerHTML = 'ğŸ”Š'; 
Â  Â  Â  speakerButton.onclick = () => speakEnglishWord(question.englishWordForPronunciation);

Â  Â  Â  questionText.innerHTML = '';
Â  Â  Â  questionText.appendChild(questionSpan);
Â  Â  Â  questionText.appendChild(speakerButton);

Â  Â  Â  answersContainer.innerHTML = ''; 
Â  Â  Â  feedback.textContent = ""; 
Â  Â  Â  pronunciationStatus.textContent = ""; 

Â  Â  Â  // Cáº­p nháº­t Ä‘iá»u kiá»‡n nÃ y Ä‘á»ƒ bao gá»“m translate_sentence_en_to_vn
Â  Â  Â  if (question.type === "multiple_choice_meaning_vn" || question.type === "translate_sentence_en_to_vn") {
Â  Â  Â  Â  let optionsToDisplay = [...question.options]; 
Â  Â  Â  Â  
Â  Â  Â  Â  // Äáº£m báº£o cÃ³ options Ä‘á»ƒ hiá»ƒn thá»‹
Â  Â  Â  Â  if (optionsToDisplay.length === 0) {
Â  Â  Â  Â  Â  // Náº¿u khÃ´ng cÃ³ options, cÃ³ thá»ƒ hiá»ƒn thá»‹ má»™t thÃ´ng bÃ¡o hoáº·c chuyá»ƒn sang kiá»ƒu nháº­p liá»‡u
Â  Â  Â  Â  Â  const noOptionsMsg = document.createElement('p');
Â  Â  Â  Â  Â  noOptionsMsg.textContent = "No options available for this question type. Please ensure 'options' array is present in your JSON.";
Â  Â  Â  Â  Â  answersContainer.appendChild(noOptionsMsg);
Â  Â  Â  Â  Â  // Fallback to text input if no options? Or just display the message.
Â  Â  Â  Â  Â  // For now, just display the message and disable answering
Â  Â  Â  Â  Â  return; 
Â  Â  Â  Â  }

Â  Â  Â  Â  for (let i = optionsToDisplay.length - 1; i > 0; i--) {
Â  Â  Â  Â  Â  const j = Math.floor(Math.random() * (i + 1));
Â  Â  Â  Â  Â  [optionsToDisplay[i], optionsToDisplay[j]] = [optionsToDisplay[j], optionsToDisplay[i]];
Â  Â  Â  Â  }

Â  Â  Â  Â  optionsToDisplay.forEach(option => {
Â  Â  Â  Â  Â  const btn = document.createElement('button');
Â  Â  Â  Â  Â  btn.className = 'option-button'; // ThÃªm class má»›i
Â  Â  Â  Â  Â  btn.textContent = option; 
Â  Â  Â  Â  Â  btn.onclick = () => checkAnswer(btn, option); // Truyá»n button Ä‘á»ƒ cÃ³ thá»ƒ thay Ä‘á»•i class
Â  Â  Â  Â  Â  answersContainer.appendChild(btn);
Â  Â  Â  Â  });
Â  Â  Â  } else if (question.type === "copy_word") {
Â  Â  Â  Â  Â  const input = document.createElement('input');
Â  Â  Â  Â  Â  input.type = 'text';
Â  Â  Â  Â  Â  input.placeholder = "Type the word 3 times, no spaces/accents";
Â  Â  Â  Â  Â  const submitBtn = document.createElement('button');
Â  Â  Â  Â  Â  submitBtn.textContent = "Answer";
Â  Â  Â  Â  Â  submitBtn.onclick = () => checkAnswer(null, input.value.trim()); // Null cho button
Â  Â  Â  Â  Â  answersContainer.appendChild(input);
Â  Â  Â  Â  Â  answersContainer.appendChild(submitBtn);
Â  Â  Â  } else if (question.type === "part_of_speech_vn") {
Â  Â  Â  Â  Â  const input = document.createElement('input');
Â  Â  Â  Â  Â  input.type = 'text';
Â  Â  Â  Â  Â  input.placeholder = "Enter Vietnamese part of speech";
Â  Â  Â  Â  Â  const submitBtn = document.createElement('button');
Â  Â  Â  Â  Â  submitBtn.textContent = "Answer";
Â  Â  Â  Â  Â  submitBtn.onclick = () => checkAnswer(null, input.value.trim()); // Null cho button
Â  Â  Â  Â  Â  answersContainer.appendChild(input);
Â  Â  Â  Â  Â  answersContainer.appendChild(submitBtn);
Â  Â  Â  } else if (question.type === "example_vn_fill_blank") {
Â  Â  Â  Â  Â  const input = document.createElement('input');
Â  Â  Â  Â  Â  input.type = 'text';
Â  Â  Â  Â  Â  input.placeholder = "Fill in the blank";
Â  Â  Â  Â  Â  const submitBtn = document.createElement('button');
Â  Â  Â  Â  Â  submitBtn.textContent = "Answer";
Â  Â  Â  Â  Â  submitBtn.onclick = () => checkAnswer(null, input.value.trim()); // Null cho button
Â  Â  Â  Â  Â  answersContainer.appendChild(input);
Â  Â  Â  Â  Â  answersContainer.appendChild(submitBtn);
Â  Â  Â  } else if (question.type === "pronunciation_check") { 
Â  Â  Â  Â  Â  const wordToPronounce = question.englishWordForPronunciation;
Â  Â  Â  Â  Â  const promptText = document.createElement('p');
Â  Â  Â  Â  Â  promptText.textContent = `Please pronounce the word: "${wordToPronounce}"`;
Â  Â  Â  Â  Â  answersContainer.appendChild(promptText);

Â  Â  Â  Â  Â  const startRecBtn = document.createElement('button');
Â  Â  Â  Â  Â  startRecBtn.textContent = "Start Recording ğŸ¤";
Â  Â  Â  Â  Â  startRecBtn.onclick = () => startRecording(wordToPronounce);
Â  Â  Â  Â  Â  answersContainer.appendChild(startRecBtn);
Â  Â  Â  // Loáº¡i bá» block 'sentence_translation_en_vn' cÅ© vÃ¬ nÃ³ sáº½ Ä‘Æ°á»£c xá»­ lÃ½ chung vá»›i multiple choice
Â  Â  Â  } else { // Fallback for any other types or missing options
Â  Â  Â  Â  Â  // Náº¿u khÃ´ng cÃ³ options vÃ  khÃ´ng pháº£i cÃ¡c loáº¡i Ä‘áº·c biá»‡t, trá»Ÿ láº¡i kiá»ƒu nháº­p liá»‡u vÄƒn báº£n
Â  Â  Â  Â  Â  const input = document.createElement('input');
Â  Â  Â  Â  Â  input.type = 'text';
Â  Â  Â  Â  Â  input.placeholder = "Enter your answer here";
Â  Â  Â  Â  Â  const submitBtn = document.createElement('button');
Â  Â  Â  Â  Â  submitBtn.textContent = "Answer";
Â  Â  Â  Â  Â  submitBtn.onclick = () => checkAnswer(null, input.value.trim());
Â  Â  Â  Â  Â  answersContainer.appendChild(input);
Â  Â  Â  Â  Â  answersContainer.appendChild(submitBtn);
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  quizContainer.style.display = 'block'; 
Â  Â  }

Â  Â  // Chá»‰nh sá»­a hÃ m checkAnswer Ä‘á»ƒ nháº­n thÃªm tham sá»‘ lÃ  nÃºt Ä‘Ã£ Ä‘Æ°á»£c click
Â  Â  function checkAnswer(clickedButton, answer) {
Â  Â  Â  const question = quizQuestions[currentQuestionIndex];
Â  Â  Â  let correct = false;
Â  Â  Â  
Â  Â  Â  // Äá»‘i vá»›i cÃ¡c loáº¡i cÃ¢u há»i vÄƒn báº£n vÃ  lá»±a chá»n, chÃºng ta chuáº©n hÃ³a vÃ  so sÃ¡nh tiáº¿ng Viá»‡t
Â  Â  Â  if (question.type === "multiple_choice_meaning_vn" || question.type === "translate_sentence_en_to_vn" || question.type === "copy_word" || question.type === "part_of_speech_vn" || question.type === "example_vn_fill_blank") {
Â  Â  Â  Â  Â  let actualAnswer = normalizeVN(answer); 
Â  Â  Â  Â  Â  let expectedAnswer = question.correctAnswer; 
Â  Â  Â  Â  Â  correct = actualAnswer === expectedAnswer;
Â  Â  Â  } else if (question.type === "pronunciation_check") {
Â  Â  Â  Â  Â  // Kiá»ƒm tra phÃ¡t Ã¢m cÃ³ hÃ m checkPronunciation riÃªng, khÃ´ng gá»i trá»±c tiáº¿p checkAnswer
Â  Â  Â  Â  Â  return; 
Â  Â  Â  } else {
Â  Â  Â  Â  Â  // Dá»± phÃ²ng cho cÃ¡c loáº¡i khÃ¡c khÃ´ng Ä‘Æ°á»£c xá»­ lÃ½ rÃµ rÃ ng báº±ng chuáº©n hÃ³a
Â  Â  Â  Â  Â  correct = answer === question.correctAnswer;
Â  Â  Â  }

Â  Â  Â  // VÃ´ hiá»‡u hÃ³a táº¥t cáº£ cÃ¡c nÃºt hoáº·c input sau khi tráº£ lá»i
Â  Â  Â  answersContainer.querySelectorAll('button').forEach(btn => btn.disabled = true); 
Â  Â  Â  answersContainer.querySelectorAll('input').forEach(input => input.disabled = true); 

Â  Â  Â  // ÄÃ¡nh dáº¥u nÃºt Ä‘Æ°á»£c chá»n (náº¿u cÃ³)
Â  Â  Â  if (clickedButton) {
Â  Â  Â  Â  if (correct) {
Â  Â  Â  Â  Â  clickedButton.classList.add('correct-answer');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  clickedButton.classList.add('incorrect-answer');
Â  Â  Â  Â  Â  // Highlight correct answer if it was a multiple choice question
Â  Â  Â  Â  Â  answersContainer.querySelectorAll('.option-button').forEach(btn => {
Â  Â  Â  Â  Â  Â  if (normalizeVN(btn.textContent) === question.correctAnswer) {
Â  Â  Â  Â  Â  Â  Â  btn.classList.add('correct-answer');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  // Sá»­ dá»¥ng displayCorrectAnswer Ä‘á»ƒ hiá»ƒn thá»‹ pháº£n há»“i vÃ  lá»‹ch sá»­
Â  Â  Â  const correctTextForDisplay = question.displayCorrectAnswer; 
Â  Â  Â  feedback.textContent = correct ? "âœ… Correct!" : `âŒ Incorrect. The answer is: ${correctTextForDisplay}`;

Â  Â  Â  const listItem = document.createElement('li');
Â  Â  Â  const userAnswerText = answer; 
Â  Â  Â  listItem.innerHTML = 
Â  Â  Â  Â  `<strong>Question:</strong> ${question.question}<br>
Â  Â  Â  Â  <strong>Your Answer:</strong> ${userAnswerText}<br>
Â  Â  Â  Â  <strong>Result:</strong> ${correct ? 'âœ… Correct' : `âŒ Incorrect (Answer: ${correctTextForDisplay})`}`;
Â  Â  Â  historyList.appendChild(listItem);
Â  Â  Â  historyList.scrollTop = historyList.scrollHeight; 

Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  quizContainer.style.display = 'none';
Â  Â  Â  Â  feedback.textContent = "";
Â  Â  Â  Â  pronunciationStatus.textContent = "";
Â  Â  Â  Â  video.play();
Â  Â  Â  }, 2000);
Â  Â  }

Â  </script>
</body>
</html>
